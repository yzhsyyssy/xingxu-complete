<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ˜Ÿè¯­ç“¶ - æ˜Ÿå™</title>
  <link rel="stylesheet" href="./common.css" />
  <style>
    .container { min-height: 100vh; position: relative; padding-bottom: 70px; }
    .bottle-card { position: relative; max-height: 220px; overflow: hidden }
    .bottle-card.expanded { max-height: 50vh; background: rgba(74,59,94,.2); box-shadow: 0 2px 15px rgba(74,59,94,.3) }
    .bottle-header { display:flex; align-items:center; gap:8px; margin-bottom:6px }
    .bottle-date { color: var(--text-secondary); font-size: 12px }
    .bottle-sender { position:absolute; right:12px; bottom:12px; font-size: 12px; color: var(--accent-purple); background: rgba(74,59,94,.2); padding: 2px 8px; border-radius: 10px }
    .favorite { position:absolute; left: 12px; bottom:12px; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: rgba(74,59,94,.2) }
    .delete { position:absolute; top: 10px; right: 10px; width: 24px; height:24px; display:flex; align-items:center; justify-content:center; color:#B0B0B0 }
    .comment-count { position:absolute; right: 12px; bottom: 12px; display:flex; gap:6px; align-items:center; background: rgba(74,59,94,.2); border-radius:12px; padding: 2px 8px }
    .send-fab, .refresh-fab { position: fixed; right: min(30px, 6vw); width: 44px; height: 44px; border-radius: 50%; display:flex; align-items:center; justify-content:center; z-index: 120; }
    .send-fab { bottom: calc(70px + 20px); background: var(--accent-purple); }
    .refresh-fab { bottom: calc(70px + 20px + 60px); background: rgba(74,59,94,.8) }
    .modal .panel .row { display:flex; gap: 10px; justify-content: flex-end }
    .comments { max-height: 40vh; overflow:auto; margin: 10px 0 }
    .comment { padding: 10px; background: rgba(46,46,46,.8); border-radius: 8px; border-left: 2px solid rgba(74,59,94,.5); margin-bottom:10px }
    .comment .head { display:flex; justify-content:space-between; color: var(--text-secondary); font-size: 12px; margin-bottom: 6px }
  </style>
</head>
<body>
  <div class="container">
    <div class="star-bg" id="stars"></div>
    <div class="header-section">
      <div class="star-id" id="id"></div>
      <div class="title">æ˜Ÿè¯­ç“¶</div>
      <div class="subtitle">å°†å¿ƒäº‹è£…è¿›æ˜Ÿè¯­ç“¶ï¼Œé™å¾…æ˜Ÿç©ºçš„æ¸©æŸ”å›éŸ³</div>
    </div>
    <div class="card-list" id="list"></div>

    <button class="send-fab btn" id="openSend">+</button>
    <button class="refresh-fab btn" id="refresh">â†»</button>

    <!-- Send modal -->
    <div class="modal" id="sendModal">
      <div class="panel">
        <div class="title" style="text-align:center">å†™ä¸‹ä½ çš„æ˜Ÿè¯­</div>
        <textarea id="sendText" placeholder="å†™ä¸‹ä½ çš„æ˜Ÿè¯­ï¼Œç­‰å¾…å›åº”..." maxlength="100"></textarea>
        <div class="row"><button class="btn ghost" id="cancelSend">æ‚„æ‚„æ”¶èµ·</button><button class="btn" id="confirmSend">é€å¾€æ˜Ÿç©º</button></div>
      </div>
    </div>

    <!-- Delete modal -->
    <div class="modal" id="delModal"><div class="panel"><div class="title" style="text-align:center">å°†è¿™ç“¶æ˜Ÿè¯­é€å›æ˜Ÿç©ºå—ï¼Ÿ</div><div class="row"><button class="btn ghost" id="cancelDel">å†ç•™ä¸€ä¼š</button><button class="btn" id="confirmDel">é€å›æ˜Ÿç©º</button></div></div></div>

    <!-- Comments modal -->
    <div class="modal" id="cmtModal">
      <div class="panel">
        <div class="row" style="justify-content:space-between;margin-bottom:6px"><div class="title">å…±é¸£å›åº”</div><button class="btn ghost" id="closeCmt">Ã—</button></div>
        <div id="orig" style="background: rgba(74,59,94,.2); padding: 10px; border-radius: 8px; margin: 6px 0"></div>
        <div class="comments" id="cmts"></div>
        <div class="row"><input id="cmtInput" type="text" placeholder="å†™ä¸‹ä½ çš„å…±é¸£..." /><button class="btn" id="sendCmt">å‘é€</button></div>
      </div>
    </div>

    <div class="tabbar"></div>
  </div>
  <div class="toast" id="toast"></div>
  <script src="./main.js"></script>
  <script>
    const { generateStars, renderTabBar, ensureStarId, getStarDigits, loadBottles, saveBottles, loadFavorites, saveFavorites, showToast } = window.WebApp
    generateStars(document.getElementById('stars'), 60, true)
    renderTabBar(2)
    const starId = ensureStarId(); document.getElementById('id').textContent = starId

    let bottles = loadBottles()
    let expanded = -1
    let deleteIndex = -1
    let currentCmtIndex = -1

    function renderList(){
      const list = document.getElementById('list')
      list.innerHTML = ''
      bottles.forEach((b, i) => {
        const el = document.createElement('div')
        el.className = 'card bottle-card' + (expanded===i?' expanded':'')
        const preview = expanded===i ? b.content : (b.content.substring(0, 20) + (b.content.length>20 ? '...' : ''))
        el.innerHTML = `
          <div class="bottle-header"><div class="bottle-icon">ğŸ¶</div><div class="bottle-date">${b.date}</div><div class="delete" data-del="${i}">Ã—</div></div>
          <div class="bottle-content">${preview}</div>
          <div class="bottle-sender">æ¥è‡ª HD ${b.senderId} çš„æ˜Ÿè¯­</div>
          <div class="favorite" data-fav="${i}"><div class="icon" style="color:${b.favorited?'#FFD700':'rgba(255,255,255,.7)'}">â˜…</div></div>
          ${b.comments && b.comments.length>0 ? `<div class="comment-count" data-cmts="${i}">ğŸ’¬ <span>${b.comments.length}</span></div>` : ''}
        `
        el.addEventListener('click', (e)=>{
          const del = e.target.closest('[data-del]')
          const fav = e.target.closest('[data-fav]')
          const cmts = e.target.closest('[data-cmts]')
          if (del){ deleteIndex = Number(del.dataset.del); openModal('#delModal'); return }
          if (fav){ const idx = Number(fav.dataset.fav); bottles[idx].favorited = !bottles[idx].favorited; saveFavorites(bottles.filter(x=>x.favorited)); saveBottles(bottles); showToast(bottles[idx].favorited?'å·²æ·»åŠ åˆ°æ”¶è—':'å·²å–æ¶ˆæ”¶è—'); renderList(); return }
          if (cmts){ currentCmtIndex = Number(cmts.dataset.cmts); openComments(currentCmtIndex); return }
          expanded = expanded===i ? -1 : i; renderList()
        })
        list.appendChild(el)
      })
    }
    renderList()

    // send modal
    document.getElementById('openSend').onclick = () => openModal('#sendModal')
    document.getElementById('cancelSend').onclick = () => closeModal('#sendModal')
    document.getElementById('confirmSend').onclick = () => {
      const v = document.getElementById('sendText').value.trim()
      if (!v) { showToast('è¯·è¾“å…¥å†…å®¹'); return }
      const now = new Date(); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0'), hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0')
      const b = { date: `${y}.${m}.${d} ${hh}:${mm}`, content: v, senderId: getStarDigits(), favorited:false, comments:[] }
      bottles.unshift(b); saveBottles(bottles); closeModal('#sendModal'); showToast('ä½ çš„æ˜Ÿè¯­ç“¶å·²é£å‘æ˜Ÿç©ºï¼Œé™å¾…å›éŸ³'); renderList()
    }

    // delete
    document.getElementById('cancelDel').onclick = () => closeModal('#delModal')
    document.getElementById('confirmDel').onclick = () => { if (deleteIndex>=0){ bottles.splice(deleteIndex,1); saveBottles(bottles); showToast('æ˜Ÿè¯­å·²é€å›æ˜Ÿç©º'); closeModal('#delModal'); expanded=-1; renderList() } }

    // refresh random
    document.getElementById('refresh').onclick = () => {
      // generate 3 random bottles
      const texts = [
        'é»„æ˜æ—¶åˆ»ï¼ŒåŸå¸‚çš„ç¯å…‰æ¸æ¬¡äº®èµ·ï¼Œåƒæ˜¯å®‡å®™ä¸­çš„æ˜Ÿè¾°ã€‚æ¯ä¸€ç›ç¯èƒŒåï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ä¸ºäººçŸ¥çš„æ•…äº‹ã€‚',
        'ä»Šå¤©åœ¨æµ·è¾¹èµ°äº†å¾ˆä¹…ï¼Œå¬ç€æµªå£°ï¼Œçœ‹æ˜Ÿæ˜Ÿå€’æ˜ åœ¨æµ·é¢ã€‚æœ‰äº›é—®é¢˜ï¼Œåœ¨å¤§è‡ªç„¶é¢å‰æ˜¾å¾—é‚£ä¹ˆæ¸ºå°ã€‚',
        'åˆå¤œé†’æ¥ï¼Œçª—å¤–æœˆå…‰å¦‚æ°´ã€‚çªç„¶æƒ³èµ·å¾ˆä¹…ä»¥å‰çš„ä¸€åœºå‘Šåˆ«ï¼Œé‚£æ—¶ä¹Ÿæ˜¯è¿™æ ·çš„æœˆè‰²ã€‚',
        'ä¸‹é›¨æ—¶æ€»ä¼šæƒ³èµ·ä½ ï¼Œå› ä¸ºä½ è¯´è¿‡å–œæ¬¢é›¨å£°ã€‚ä¸çŸ¥é“åœ¨ä½ çš„åŸå¸‚ï¼Œæ˜¯å¦ä¹Ÿåœ¨ä¸‹é›¨ï¼Ÿ',
        'æ—¶é—´æ˜¯æœ€å¥‡å¦™çš„ä¸œè¥¿ï¼Œå®ƒèƒ½å¸¦èµ°ä¼¤ç—›ï¼Œä¹Ÿèƒ½è®©å›å¿†å˜å¾—æ¸©æŸ”ã€‚',
        'å‡Œæ™¨ä¸¤ç‚¹ï¼Œæ•´åº§åŸå¸‚ä»¿ä½›åªæœ‰æˆ‘ä¸€ä¸ªäººé†’ç€ã€‚è¿™ç§æ—¶åˆ»ï¼Œæ€ç»ªæ€»æ˜¯ç‰¹åˆ«æ¸…æ™°ã€‚',
      ]
      const now = new Date(); const y=now.getFullYear()
      const randomB = Array.from({length:3}, ()=>{
        const d = new Date(now); d.setDate(d.getDate()-Math.floor(Math.random()*30))
        const mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), hh=String(Math.floor(Math.random()*24)).padStart(2,'0'), mi=String(Math.floor(Math.random()*60)).padStart(2,'0')
        return { date: `${y}.${mm}.${dd} ${hh}:${mi}`, content: texts[Math.floor(Math.random()*texts.length)], senderId: String(Math.floor(Math.random()*1e6)).padStart(6,'0'), favorited:false, comments:[] }
      })
      const fav = bottles.filter(b=>b.favorited)
      bottles = [...randomB, ...fav]; saveBottles(bottles); showToast('å‘ç°æ–°çš„æ˜Ÿè¯­ç“¶'); renderList()
    }

    // comments modal
    function openComments(i){
      const b = bottles[i]
      document.getElementById('orig').innerHTML = `<div style="color:#B0B0B0;font-size:12px;margin-bottom:6px">${b.date} HD ${b.senderId}</div><div>${b.content}</div>`
      renderComments(i)
      openModal('#cmtModal')
    }
    function renderComments(i){
      const box = document.getElementById('cmts'); box.innerHTML = ''
      const b = bottles[i]
      if (!Array.isArray(b.comments)) b.comments = []
      b.comments.forEach(c => {
        const el = document.createElement('div')
        el.className = 'comment'
        el.innerHTML = `<div class="head"><div>HD ${c.senderId}</div><div>${c.date}</div></div>` + (c.isImage?`<img src="${c.content}" style="max-width:220px;border-radius:6px" />`:`<div>${c.content}</div>`)
        box.appendChild(el)
      })
    }
    document.getElementById('closeCmt').onclick = () => closeModal('#cmtModal')
    document.getElementById('sendCmt').onclick = () => {
      if (currentCmtIndex<0) return
      const input = document.getElementById('cmtInput')
      const v = input.value.trim(); if (!v){ showToast('è¯·è¾“å…¥å†…å®¹'); return }
      const now = new Date(); const mm=String(now.getMonth()+1).padStart(2,'0'), dd=String(now.getDate()).padStart(2,'0'), hh=String(now.getHours()).padStart(2,'0'), mi=String(now.getMinutes()).padStart(2,'0')
      const c = { date: `${mm}.${dd} ${hh}:${mi}`, content: v, senderId: getStarDigits(), isImage:false }
      bottles[currentCmtIndex].comments.push(c); saveBottles(bottles); input.value=''; showToast('å…±é¸£å·²é€å‡º'); renderComments(currentCmtIndex); renderList()
    }

    // close modal when clicking background
    document.getElementById('sendModal').addEventListener('click', (e)=>{ if (e.target.id==='sendModal') closeModal('#sendModal') })
    document.getElementById('delModal').addEventListener('click', (e)=>{ if (e.target.id==='delModal') closeModal('#delModal') })
    document.getElementById('cmtModal').addEventListener('click', (e)=>{ if (e.target.id==='cmtModal') closeModal('#cmtModal') })
  </script>
</body>
</html>


